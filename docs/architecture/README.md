# Архитектура проекта

Этот раздел описывает архитектуру проекта, принципы проектирования и организацию кода.

## Содержание

- [Обзор архитектуры](./overview.md) - Общее описание архитектуры и принципов
- [Слои приложения](./layers.md) - Подробное описание каждого слоя
- [Структура директорий](./directory-structure.md) - Организация файлов и папок
- [Потоки данных](./data-flow.md) - Как данные проходят через приложение
- [Обработка ошибок](./error-handling.md) - Стратегия обработки ошибок
- [Контекст и таймауты](./context.md) - Работа с контекстами в fasthttp

## Чистая архитектура

Проект следует принципам Clean Architecture (Чистой архитектуры), которая разделяет приложение на независимые слои:

```
┌─────────────────────────────────────┐
│         API Layer (Handlers)        │  ← HTTP интерфейс
├─────────────────────────────────────┤
│      Use Case Layer (Business)      │  ← Бизнес-логика
├─────────────────────────────────────┤
│    Repository Layer (Data Access)   │  ← Доступ к данным
├─────────────────────────────────────┤
│      Domain Layer (Entities)        │  ← Сущности и правила
└─────────────────────────────────────┘
```

### Преимущества такой архитектуры

1. **Независимость** - Каждый слой может изменяться независимо
2. **Тестируемость** - Легко создавать моки и тесты
3. **Масштабируемость** - Простое добавление новых функций
4. **Поддерживаемость** - Понятная структура кода

## Основные принципы

### Dependency Rule (Правило зависимостей)

Зависимости направлены внутрь: внешние слои зависят от внутренних, но не наоборот.

- **API** → **UseCase** → **Repository** → **Domain**
- **Domain** не зависит ни от чего

### Single Responsibility (Единственная ответственность)

Каждый модуль отвечает за одну вещь:

- `domain/` - только сущности и бизнес-правила
- `usecase/` - только бизнес-логика
- `repository/` - только доступ к данным
- `api/handler/` - только HTTP обработка

### Interface Segregation (Разделение интерфейсов)

Интерфейсы маленькие и специфичные:

```go
// Хорошо: маленький интерфейс
type UserRepository interface {
    GetByID(ctx context.Context, id string) (*User, error)
    Update(ctx context.Context, user *User) error
}

// Плохо: большой интерфейс со всем подряд
type Repository interface {
    // 50 методов...
}
```

## Слои подробно

### Domain Layer (Слой домена)

**Расположение**: `domain/`

Содержит:
- Сущности (User, Task, Session)
- Бизнес-правила
- Ошибки домена
- Типы и константы

**Особенности**:
- Не зависит от внешних библиотек
- Содержит только бизнес-логику
- Легко тестируется

### Use Case Layer (Слой бизнес-логики)

**Расположение**: `usecase/`

Содержит:
- Бизнес-логику приложения
- Оркестрацию вызовов репозиториев
- Валидацию данных
- Интеграцию с буфером для offline операций

**Особенности**:
- Зависит только от Domain и Repository интерфейсов
- Не знает о HTTP или базе данных напрямую
- Легко тестируется с моками

### Repository Layer (Слой доступа к данным)

**Расположение**: `repository/`

Содержит:
- Интерфейсы репозиториев
- Реализации для PostgreSQL и Redis
- Маппинг между БД и доменными сущностями

**Особенности**:
- Абстрагирует детали БД
- Легко заменить реализацию (например, на MongoDB)
- Использует интерфейсы для тестирования

### API Layer (HTTP слой)

**Расположение**: `api/handler/`

Содержит:
- HTTP обработчики
- Сериализацию запросов/ответов
- Валидацию входных данных
- Обработку ошибок

**Особенности**:
- Тонкий слой, делегирует работу UseCase
- Не содержит бизнес-логику
- Легко добавить новые эндпоинты

## Инфраструктура

**Расположение**: `internal/infrastructure/`

Содержит:
- Подключения к БД (PostgreSQL, Redis, BoltDB)
- Мониторинг соединений
- Миграции БД
- Буфер для offline операций

## Middleware

**Расположение**: `internal/middleware/`

Содержит:
- JWT аутентификацию
- Логирование запросов
- CORS
- Request ID

## Следующие шаги

- [Подробнее о слоях](./layers.md)
- [Структура директорий](./directory-structure.md)
- [Потоки данных](./data-flow.md)

